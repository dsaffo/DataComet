<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 80%; width: 70%; float:left;}
        #graph_div { width: 30%; top: 0; right: 0; position: absolute;}
        #timeline_div {height: 20%; width: 70%; bottom: 10px; position: absolute; margin-top: 20px;}
        #line1_div {width: 30%; top:300px ; right: 0; position: absolute;}
        #line2_div {width: 30%; top:600px ; right: 0; position: absolute;}
      
      
      .dronePathStyle{
        fill: none;
        stroke: red;
        stroke-width: var(--element-width);
      }
      
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <link rel="stylesheet" type="text/css" href="timeline.css">
    <!-- <link rel="stylesheet" type="text/css" href="line-charts.css"> -->

</head>
<body>
    
  <div id="map-canvas" style="position: relative; z-index: 1">
    <div class="row">
    <div class="switch" style="position: relative; z-index: 2; float: right; margin-top: 10px; margin-right: 26px">
      <label style="color: white; font-size: 15px">
        Width: Off
      <input id='widthSwitch' type="checkbox">
      <span class="lever"></span>
        On
      </label>
    </div>
    </div>
     <div class="row">
    <div class="switch" style="position: relative; z-index: 2; float: right; margin-right: 10px">
      <label style="color: white; font-size: 15px">
        Scale: Global
      <input id='colorSwitch' type="checkbox">
      <span class="lever"></span>
        Local
      </label>
    </div>
    </div>
  </div>
 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
      
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="L.D3SvgOverlay.js"></script>
      
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
  <script src="line-charts.js"></script>

  <div id='timeline_div'>
    <svg width="1360" height="150" id='timeline'></svg>
  </div>
  <div id='graph_div'>
    <svg width="570" height="300" id='line0'></svg>
  </div>
  <br>
  <div id="line1_div">
     <svg width="570" height="300" id='line1'></svg>
</div>
<br>
<div id="line2_div">
   <svg width="570" height="300" id='line2'></svg>
</div>

  <script src="timeline.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="https://d3js.org/d3-path.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
            

  <!-- <script src="line-charts.js"></script> -->

<!-- </div> -->


<script>
    
//the map
var map = L.map("map-canvas",{center:[32.3873506, -117.0765251],zoom:19,maxZoom:25,minZoom:16});
var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    maxNativeZoom: 18
});
Esri_WorldTopoMap.addTo(map);

  
//some data holders  
var droneData = [];
var start = [];
var window2 = [];
var widthSwitch = false;
var colorSwitch = false;

  //callback to render svg on the map  
  

  function selectColorScale(data, value, cmap){
    
    max = d3.max(data, function(d){ return parseInt(d[value]); });
    var colorScale = d3.scaleSequential(d3["interpolate" + cmap])
        .domain([0, max]);
    
    return colorScale;
  }
  
  function drawMap(window, widthSwitch, colorSwitch){
   
    var pathOverlay = L.d3SvgOverlay(function(sel,proj){
     
      d3.selectAll('#drone').remove();
      d3.selectAll('circle').remove();
      
      selectedData = [];
      
      //color scale for battery
      var max = d3.max(droneData,function(d){return parseInt(d['jamming_indicator'])});
      var median = d3.median(droneData,function(d){return d.jamming_indicator});
      //console.log('max',max);
      //var colorScale = d3.scaleSequential(d3.interpolateReds).domain([0, max]);
     
      //our line generator
      var line = d3.line()
        .x(function(d){ return proj.latLngToLayerPoint(d).x; })
        .y(function(d){ return proj.latLngToLayerPoint(d).y; })

    
      
      timeWindow = window;
      window2 = window; 

      for(i = timeWindow[0]; i < timeWindow[1]; i++){
        selectedData.push(droneData[i])
      }
      
      if (colorSwitch == true){
        colorScale = selectColorScale(selectedData,'jamming_indicator','Reds')
      }
      
      else{ 
        colorScale = selectColorScale(droneData,'jamming_indicator','Reds')
      }
     
           var path = sel.selectAll('path')
        .data(selectedData)
        .enter().append('path')
        .attr('stroke', function(d) { return colorScale(parseInt(d.jamming_indicator)) })
        .attr('id', 'drone')
        .attr('d', function(d){ return line([d.startlatLng,d.endlatLng])})
        .style('stroke-width', map.getZoom());

      if (widthSwitch == true){
        path.style('stroke-width', function(d){ return d.jamming_indicator;});
      }
        
      

      var circle = sel.append("circle")
                      .attr("cx", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).x;})
                      .attr("cy", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).y;})
                      .attr("r", map.getZoom())
                      .attr('fill',function(d){return colorScale(selectedData[selectedData.length - 1].jamming_indicator)});


  


      console.log('zoom', map.getZoom());
      console.log('scale', proj.scale);

  

    }, options = {zoomDraw:false});

    d3.csv("milestone3.csv",function(data){
        startlat = 323873506 / 10000000
        startlon = -1170765251 / 10000000
        droneData = data.map(function(d){
        endlat = d.lat/10000000  
        endlon =  d.lon/10000000 
        d.startlatLng = [+startlat,+startlon];    
        d.endlatLng = [+endlat,+endlon];
        // console.log("start",startlat,startlon)
        // console.log("end",endlat,endlon)
        startlat = endlat
        startlon = endlon
        //var max = d3.max(data,function(d){console.log('jam',typeof d['jamming_indicator']); return d['jamming_indicator']});
        
        //console.log('max',max);
        return d;
      });
    pathOverlay.addTo(map);
    });
  }

  
map.on('zoomend', function() {
  drawMap(window2,widthSwitch,colorSwitch);
});
  
window.addEventListener('timeline_update', function (e) {
  if(colorSwitch == true){
    colorSwitch = false;
    document.getElementById("colorSwitch").checked = false;
  }
  drawMap(e.detail,widthSwitch,colorSwitch);
});

document.getElementById("widthSwitch").addEventListener("change", function(){
  if (widthSwitch == false){
    widthSwitch = true;
  }
  else{
    widthSwitch = false;
  }
  drawMap(window2,widthSwitch);
});
document.getElementById("colorSwitch").addEventListener("change", function(){
  if (colorSwitch == false){
    colorSwitch = true;
  }
  else{
    colorSwitch = false;
  }
  drawMap(window2,widthSwitch,colorSwitch);
});

</script>
    
    
</body>
</html>