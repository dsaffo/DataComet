<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 80%; width: 70%; float:left;}
        #graph_div { width: 30%; top: 0; right: 0; position: absolute;}
        #timeline_div {height: 20%; width: 70%; bottom: 10px; position: absolute; margin-top: 20px;}
        #line1_div {width: 30%; top:300px ; right: 0; position: absolute;}
        #line2_div {width: 30%; top:600px ; right: 0; position: absolute;}
      
      
      .dronePathStyle{
        fill: none;
        stroke: red;
        stroke-width: var(--element-width);
      }
      
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <link rel="stylesheet" type="text/css" href="timeline.css">
    <!-- <link rel="stylesheet" type="text/css" href="line-charts.css"> -->

</head>
<body>
  <div id="map-canvas"></div>
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
      
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="L.D3SvgOverlay.js"></script>
      
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
  <script src="line-charts.js"></script>

  <div id='timeline_div'>
    <svg width="1360" height="150" id='timeline'></svg>
  </div>
  <div id='graph_div'>
    <svg width="570" height="300" id='line0'></svg>
  </div>
  <br>
  <div id="line1_div">
     <svg width="570" height="300" id='line1'></svg>
</div>
<br>
<div id="line2_div">
   <svg width="570" height="300" id='line2'></svg>
</div>

  <script src="timeline.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="https://d3js.org/d3-path.v1.min.js"></script>

  <!-- <script src="line-charts.js"></script> -->

<!-- </div> -->


<script>
    
//the map
var map = L.map("map-canvas",{center:[32.3873506, -117.0765251],zoom:18,maxZoom:25,minZoom:10});
var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
});
Esri_WorldTopoMap.addTo(map);
  
//some data holders  
var droneData = [];
var start = [];
  
window.addEventListener('timeline_update', function (e) {
//callback to render svg on the map  
});
var pathOverlay = L.d3SvgOverlay(function(sel,proj){
  d3.selectAll('#drone').remove();
  d3.selectAll('circle').remove();
  selectedData = [];
  //color scale for battery
  var colorScale = d3.scaleSequential(d3.interpolateReds).domain([d3.min(droneData,function(d){return d.remaining}),d3.max(droneData,function(d){return d.remaining})]);

  //our line generator
  var line = d3.line()
    .x(function(d){ return proj.latLngToLayerPoint(d).x; })
    .y(function(d){ return proj.latLngToLayerPoint(d).y; })
  
  //scale for our svg elements
  scale = (1 / proj.scale) * 5;
  
  timeWindow = e.detail;
  console.log(timeWindow)
  
  for(i = timeWindow[0]; i < timeWindow[1]; i++){
    selectedData.push(droneData[i])
  }
  console.log(selectedData);
  
  
   var path = sel.selectAll('path')
    .data(selectedData)
    .enter().append('path')
    .attr('stroke', 'red')
    .attr('id', 'drone')
    .attr('d', function(d){ return line([d.startlatLng,d.endlatLng])});

  
  var circle = sel.append("circle")
                  .attr("cx", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).x;})
                  .attr("cy", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).y;})
                  .attr("r", scale);
  
  sel.selectAll('drone').style('stroke-width', scale);
  
  sel.selectAll('circle').attr('r', scale);


  function moveLine(elem, size,start){

    const t = d3.transition().duration(500).ease(d3.easeLinear);

    elem.attr('stroke', function(d){return colorScale(d.remaining)})
        .style('stroke-width', size * 5)
        .attr('d', function(d){return line([d.startlatLng,d.startlatLng])})
        .transition(t)
        .attr('d', function(d){return line([d.startlatLng,d.endlatLng])});
  }

  function moveCircle(elem, size, start){
    const t = d3.transition().duration(500).ease(d3.easeLinear);
    elem.attr("r", size * 5)
      .transition(t)
      .attr("cx", function(d){return proj.latLngToLayerPoint(start[start.length - 1].endlatLng).x;})
      .attr("cy", function(d){return proj.latLngToLayerPoint(start[start.length - 1].endlatLng).y;})

  }

    

    //


   /* d3.interval(function(){


 if (droneData.length !=0){
  start.push(droneData.shift());

  }
  size = 1 / proj.scale


  var path = sel.selectAll('path')
    .data(start)
    .enter().append('path')
  


  sel.selectAll('path').style('stroke-width', size * 5)

  moveLine(path, size, start);

  moveCircle(circle, size, start);  


  }, 500);
*/
      
}, options = {zoomDraw:false});
    
d3.csv("milestone3.csv",function(data){
    startlat = 323873506 / 10000000
    startlon = -1170765251 / 10000000
    droneData = data.map(function(d){
    endlat = d.lat/10000000  
    endlon =  d.lon/10000000 
    d.startlatLng = [+startlat,+startlon];    
    d.endlatLng = [+endlat,+endlon];
    // console.log("start",startlat,startlon)
    // console.log("end",endlat,endlon)
    startlat = endlat
    startlon = endlon
    return d;
  });
 pathOverlay.addTo(map);
});

window.addEventListener('timeline_update', function (e) {
        // console.log('Timeline range changed to:', e.detail);
});
</script>
    
    
</body>
</html>