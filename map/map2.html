<!DOCTYPE html>
<html>
<head>
  <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

  <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    rel='stylesheet' type='text/css'/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta charset="utf-8"/>
  <link rel="stylesheet" type="text/css" href="timeline.css">

  <!-- Materialize CSS -->
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
    #map-canvas { height: 90%; width: 70%; float:left;}
    #timeline_div {height: 10%; width: 70%; bottom: 10px; position: absolute; margin-top: 20px;}
    #right_bar_div {height:100%; width:30%; float:right}
    #graphs_div {height: 80%; width: 100%;}
    #line1_div {width: 95%; height:33.3%; top: 0; right: 0; float: right}
    #line2_div {width: 95%; height:33.3%; top:30% ; right: 0; float:right}
    #line3_div {width: 95%; height:33.3%; top:60% ; right: 0; float:right;}
    #radio_div {width: 5%; height:100%; float:left}
    #radio1 {height:33.3%; bottom:0%}
    #radio2 {height:33.3%; bottom:0%}
    #radio3 {height:33.3%; bottom:0%}
    #tabs_div {height: 2%; width: 100%;}
    #select_div {height: 2%; width: 100%;}
    #modal_div {height:5%; width: 15%; float:right;}
    /* #graphs_div {height: 80%; width: 30%; float:right;}
    #line1_div {width: 95%; height:33.3%; top: 0; right: 0; float: right}
    #line2_div {width: 95%; height:33.3%; top:30% ; right: 0; float:right}
    #line3_div {width: 95%; height:33.3%; top:60% ; right: 0; float:right;}
    #radio_div {width: 5%; height:100%; float:left}
    #radio1 {height:33.3%; bottom:0%}
    #radio2 {height:33.3%; bottom:0%}
    #radio3 {height:33.3%; bottom:0%}
    #tabs_div {height: 3%; width: 30%; float:right; margin-bottom: 0px;}
    #select_div {height: 3%; width: 30%; float:right; margin-top: 30px;} */
  
  .dronePathStyle{
    fill: none;
    stroke: red;
    stroke-width: var(--element-width);
  }
  
</style>
</head>

<body>
<body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <div id="map-canvas" style="position: relative; z-index: 1">
    <div class="row">
    <div class="switch" style="position: relative; z-index: 2; float: right; margin-top: 10px; margin-right: 26px">
      <label style="color: white; font-size: 15px">
        Width: Off
      <input id='widthSwitch' type="checkbox">
      <span class="lever"></span>
        On
      </label>
    </div>
    </div>
     <div class="row">
    <div class="switch" style="position: relative; z-index: 2; float: right; margin-right: 10px">
      <label style="color: white; font-size: 15px">
        Scale: Global
      <input id='colorSwitch' type="checkbox">
      <span class="lever"></span>
        Local
      </label>
    </div>
    </div>
  </div>
 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
      
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="L.D3SvgOverlay.js"></script>
      
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>

  <!-- Create Timeline and Line Graphs -->
  <div id='timeline_div'>
    <svg width="1360" height="150" id='timeline'></svg>
  </div>

  <div id='right_bar_div'>
    <div id="graphs_div">
      <div id="radio_div">
          <form action="#" style="height: 100%;">
            <p id='radio1'>
              <label>
                <input name="group1" type="radio" value="1" id="radio1_input" checked />
                <span style="top: 30%; left: 20%"></span>
              </label>
            </p>
            <p id='radio2'>
              <label>
                <input name="group1" type="radio" value="2" id="radio2_input"/>
                <span style="top: 30%; left: 20%"></span>
              </label>
            </p>
            <p id='radio3'>
              <label>
                <input name="group1" type="radio" value="3" id="radio3_input"/>
                <span style="top: 30%; left: 20%"></span>
              </label>
            </p>
          </form>
        </div>
      <div id='line1_div'>
        <svg width="570" height="300" id='line0'></svg>
      </div>
      <div id="line2_div">
        <svg width="570" height="300" id='line1'></svg>
      </div>
      <div id="line3_div">
        <svg width="570" height="300" id='line2'></svg>
      </div>
    </div>

    <!-- Create Tabs -->
    <div class="row" id="tabs_div">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s3" id='tab1'><a class="active" href="#1" style="font-size: 16px">Signal</a></li>
          <li class="tab col s3" id='tab2'><a href="#2" style="font-size: 16px">Physical</a></li>
          <li class="tab col s3" id='tab3'><a href="#3" style="font-size: 16px">System</a></li>
          <li class="tab col s3" id='tab4'><a href="#4" style="font-size: 16px">Misc.</a></li>
        </ul>
      </div>
    </div>
    
    <div class="row" id = "select_div">
      <div class="input-field col s12">
        <select id='logSelect'>
          <option value="milestone3.csv">mileston 3</option>
          <option value="milestone3_modified.csv">mileston 3 moar</option>
          <option value="spaghetti.csv">spaghetti</option>
        </select>
        <label>Select Log</label>
      </div>
    </div>


    <div id="modal_div">
      <!-- Modal Trigger -->
      <a class="waves-effect waves-light modal-trigger btn-floating btn-large red" href="#modal1">
        <i class="medium material-icons" style="font-size: 2.8rem;">info_outline</i>
      </a>

      <!-- Modal Structure -->
      <div id="modal1" class="modal">
        <div class="modal-content">
          <h4>Data Comets</h4>
          <p>INSERT NAMES HERE</p>
          <p><b>Motivation</b>: </p>
          <p>Data</p>
          <p>Task Analysis</p>
          <p>Design Process</p>
          <p>Final Visualization</p>
          <p>Data Analysis</p>
          <p>Conclusion</p>
        </div>
        <!-- <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
        </div> -->
      </div>
    </div>
  </div>


<script src="timeline.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>

<script src="https://d3js.org/d3-path.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>


    
            

  <!-- <script src="line-charts.js"></script> -->

<!-- </div> -->


  <script src="https://d3js.org/d3-path.v1.min.js"></script>


<script>
    
//the map
var map = L.map("map-canvas",{center:[0,0],zoom:19,maxZoom:25,minZoom:1});

  
//some data holders  
var droneData = [];
var start = [];
var window2 = [];
// tabs and radio
var radioValue = 1;
var yAttr = 'noise_per_ms';


  
        
    
    //
  function draw(data){
    
      startlat = data[0].lat / 10000000;
      startlon = data[0].lon / 10000000;
      map.remove();
      map = L.map("map-canvas",{center:[startlat,startlon],zoom:19,maxZoom:25,minZoom:1});
      var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        maxNativeZoom: 18
      });
      Esri_WorldTopoMap.addTo(map);

    
      droneData = data.map(function(d){
        endlat = d.lat/10000000  
        endlon =  d.lon/10000000 
        d.startlatLng = [+startlat,+startlon];    
        d.endlatLng = [+endlat,+endlon];
        startlat = endlat
        startlon = endlon
        return d;
      });
  //console.log(droneData);
  window2 = [0, droneData.length];
  //console.log(window2);
  function selectColorScale(data, value, cmap){
    
    max = d3.max(data, function(d){ return parseFloat(d[value]); });
    min = d3.min(data, function(d){ return parseFloat(d[value]); });
    //console.log(min,max)
    var colorScale = d3.scaleSequential(d3["interpolate" + cmap])
        .domain([min, max]);
    
    return colorScale;
  }
    
  function widthScale(data, value){
    max = d3.max(data, function(d){ return parseFloat(d[value]); });
    min = d3.min(data, function(d){ return parseFloat(d[value]); });
    return widthScaler = d3.scaleLinear().domain([min, max]).range([1,40]);
  }
  
  function drawMap(window){
    
    var cmap = 'Reds'
    
    if (radioValue == 1){
      cmap = 'Reds'
    }
    else if (radioValue == 2){
      cmap = 'Blues'
    }
    else{
      cmap = 'Greens'
    }
   
    var pathOverlay = L.d3SvgOverlay(function(sel,proj){
     
      d3.selectAll('.drone').remove();
      d3.selectAll('circle').remove();
      
      selectedData = [];
      
      //color scale for battery
      //var max = d3.max(droneData,function(d){return parseInt(d['jamming_indicator'])});
      //var median = d3.median(droneData,function(d){return d.jamming_indicator});
      //console.log('max',max);
      //var colorScale = d3.scaleSequential(d3.interpolateReds).domain([0, max]);
     
      //our line generator
      var line = d3.line()
        .x(function(d){ return proj.latLngToLayerPoint(d).x; })
        .y(function(d){ return proj.latLngToLayerPoint(d).y; })

    
      
      //timeWindow = window;
      window2 = window; 

      //for(i = timeWindow[0]; i < timeWindow[1]; i++){
      //  selectedData.push(droneData[i])
      //}
      
      selectedData = droneData.slice(window[0],window[1] + 1);
      
      if (document.getElementById('colorSwitch').checked == true){
        colorScale = selectColorScale(selectedData,yAttr,cmap)
      }
      
      else{ 
        colorScale = selectColorScale(droneData,yAttr,cmap)
      }
     
      var path = sel.selectAll('path')
        .data(selectedData)
        .enter().append('path')
        .attr('id', function(d){ return 'time:' + d.time; })
        .attr('stroke', function(d) { return colorScale(parseFloat(d[yAttr])) })
        .attr('class', 'drone')
        .attr('d', function(d){ return line([d.startlatLng,d.endlatLng])})
        .style('stroke-width', map.getZoom())
        .on('mouseover', function(d){
            d3.select(this).style("cursor", "pointer"); 
            d3.select(this).style('stroke-width', d3.select(this).style('stroke-width') * 2);
            set_hover_line(d.time);
            //console.log(d.time);
        })
        .on('mouseout', function(d){
          if (document.getElementById('widthSwitch').checked == true){
            
            d3.select(this).style('stroke-width', function(d){ return d[yAttr]});
          }
          else{
            d3.select(this).style('stroke-width', map.getZoom());
          }
        })

      if (document.getElementById('widthSwitch').checked == true){
        //console.log('width switch')
        if (document.getElementById('colorSwitch').checked == true){
          var widthScaler = widthScale(selectedData, yAttr);
        }
        else{
          var widthScaler = widthScale(droneData, yAttr);
        }
        path.style('stroke-width', function(d){return widthScaler(d[yAttr]);});
        //path.attr('stroke-width',  function(d){return d[yAttr];});
      }
        
      

      var circle = sel.append("circle")
                      .attr("cx", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).x;})
                      .attr("cy", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).y;})
                      .attr("r", map.getZoom()/1.5)
                      .attr('fill',function(d){return colorScale(selectedData[selectedData.length - 1][yAttr])});


  


      //console.log('zoom', map.getZoom());
      //console.log('scale', proj.scale);

  

    }, options = {zoomDraw:false});

   pathOverlay.addTo(map);
  }
    
  
//draw the path for the first time
drawMap([0,droneData.length]);

  
map.on('zoomend', function() {
  drawMap(window2);
});
  
window.addEventListener('timeline_update', function (e) {
  //if(colorSwitch == true){
  //  colorSwitch = false;
  //  document.getElementById("colorSwitch").checked = false;
  //}
  drawMap(e.detail);
});

document.getElementById("widthSwitch").addEventListener("change", function(){
  drawMap(window2);
});
document.getElementById("colorSwitch").addEventListener("change", function(){
  drawMap(window2);
});

// Initializing Materialize objects
$(document).ready(function(){
    $('.tabs').tabs();
});
 $(document).ready(function(){
    $('select').formSelect();
  });

$(document).ready(function(){
  $('.modal').modal();
});

$(document).ready(function(){
  $('.fixed-action-btn').floatingActionButton();
});

$(".tab").click(function() {
  id = this.id

  $("#radio1_input").prop("checked", true);
  radioValue = 1;
  yAttr = timeline_get_attribute(id, radioValue);
  if (id == 'tab1') {
    //console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab2') {
    //console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab3') {
    //console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab4') {
    //console.log("Clicked", id);
    tab_clicked(id);
  }
  drawMap(window2);
})

// Need to listeners for radio change (one when user clicks and one when the tab is changed)!!
$("input[name='group1']").change(function(){
  var tab = $(".active").parent().attr('id');
  radioValue = $(this).val();
  yAttr = timeline_get_attribute(tab, radioValue);
  //console.log(new_attr, radio_value);
  drawMap(window2);
});
}

  
function loadData(file){
  d3.csv(file, function(data){ draw(data);});
}
  
document.getElementById('logSelect').addEventListener('change', function(){
  loadData(document.getElementById('logSelect').value);
  update_file_timeline(document.getElementById('logSelect').value);
  document.getElementById("colorSwitch").checked = false;
  document.getElementById("widthSwitch").checked = false;
});


  
function linkHoverOn(xAttr){
  d3.select('[id="time:'+xAttr+'"]')
    .style('stroke-width', d3.select('[id="time:'+xAttr+'"]')
                            .style('stroke-width') * 2);
}

function linkHoverOut(xAttr){
  // Make sure the xAttr value is valid
  if (xAttr >= 0) {
    d3.select('[id="time:'+xAttr+'"]')
    .style('stroke-width', d3.select('[id="time:'+xAttr+'"]')
                            .style('stroke-width') / 2);
  }
}

loadData(document.getElementById('logSelect').value);
update_file_timeline(document.getElementById('logSelect').value);


</script>
    
    
</body>
</html>