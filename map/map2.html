<!DOCTYPE html>
<html>
<head>
  <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

  <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    rel='stylesheet' type='text/css'/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta charset="utf-8"/>
  <link rel="stylesheet" type="text/css" href="timeline.css">

  <!-- Materialize CSS -->
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
    #map-canvas { height: 90%; width: 70%; float:left;}
    #timeline_div {height: 10%; width: 70%; bottom: 10px; position: absolute; margin-top: 20px;}
    #graphs_div {height: 90%; width: 30%; float:right;}
    #line1_div {width: 90%; height:33.3%; top: 0; right: 0; float: left}
    #line2_div {width: 90%; height:33.3%; top:30% ; right: 0; float:left}
    #line3_div {width: 90%; height:33.3%; top:60% ; right: 0; float:left;}
    #tabs_div {height: 5%; width: 30%; top:90%; float:right; margin-top:2%}
    /* #graph_div {width: 30%; top: 0; right: 0; position: absolute;}
    #line1_div {width: 30%; top:300px ; right: 0; position: absolute;}
    #line2_div {width: 30%; top:600px ; right: 0; position: absolute;} */
  
  
  .dronePathStyle{
    fill: none;
    stroke: red;
    stroke-width: var(--element-width);
  }
  
</style>
</head>

<body>

  <!-- Materialize CSS Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <div id="map-canvas"></div>
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
      
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="L.D3SvgOverlay.js"></script>
      
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
  <script src="line-charts.js"></script>

  <!-- Create Timeline and Line Graphs -->
  <div id='timeline_div'>
    <svg width="1360" height="150" id='timeline'></svg>
  </div>
  <div id="graphs_div">
    <div id='line1_div'>
      <svg width="570" height="300" id='line0'></svg>
    </div>
    <div id="line2_div">
      <svg width="570" height="300" id='line1'></svg>
    </div>
    <div id="line3_div">
      <svg width="570" height="300" id='line2'></svg>
    </div>
  </div>

  <!-- Create Tabs -->
  <div class="row" id="tabs_div">
    <div class="col s12">
      <ul class="tabs">
        <li class="tab col s3" id='tab1'><a class="active" href="#1" style="font-size: 20px">Security</a></li>
        <li class="tab col s3" id='tab2'><a href="#2" style="font-size: 20px">Physical</a></li>
        <li class="tab col s3" id='tab3'><a href="#3" style="font-size: 20px">System</a></li>
        <li class="tab col s3" id='tab4'><a href="#4" style="font-size: 20px">Environmental</a></li>
      </ul>
    </div>
  </div>

  <script src="timeline.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
  <script src="https://d3js.org/d3-path.v1.min.js"></script>

<script>
    
//the map
var map = L.map("map-canvas",{center:[32.3873506, -117.0765251],zoom:19,maxZoom:25,minZoom:10});
var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    maxNativeZoom: 18
});
Esri_WorldTopoMap.addTo(map);
  
//some data holders  
var droneData = [];
var start = [];
  
window.addEventListener('timeline_update', function (e) {
  //callback to render svg on the map  
  var pathOverlay = L.d3SvgOverlay(function(sel,proj){
    d3.selectAll('#drone').remove();
    d3.selectAll('circle').remove();
    selectedData = [];
    //color scale for battery
    var colorScale = d3.scaleSequential(d3.interpolateReds).domain([d3.min(droneData,function(d){return d.jamming_indicator}),d3.max(droneData,function(d){return d.jamming_indicator})]);

    //our line generator
    var line = d3.line()
      .x(function(d){ return proj.latLngToLayerPoint(d).x; })
      .y(function(d){ return proj.latLngToLayerPoint(d).y; })
    
    //scale for our svg elements
    scale = (1 / proj.scale) * 8;
    
    timeWindow = e.detail;
    // console.log(timeWindow)
    
    for(i = timeWindow[0]; i < timeWindow[1]; i++){
      selectedData.push(droneData[i])
    }
    // console.log(selectedData);
    
    
    var path = sel.selectAll('path')
      .data(selectedData)
      .enter().append('path')
      .attr('stroke', function(d) { return colorScale(d.jamming_indicator) })
      .attr('id', 'drone')
      .attr('d', function(d){ return line([d.startlatLng,d.endlatLng])})
      .style('stroke-width', 8);

    
    var circle = sel.append("circle")
                    .attr("cx", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).x;})
                    .attr("cy", function(d){return proj.latLngToLayerPoint(selectedData[selectedData.length - 1].endlatLng).y;})
                    .attr("r", scale);
    
    //sel.selectAll('drone').style('stroke-width', scale);
    
    sel.selectAll('circle').attr('r', scale).attr('fill',function(d){return colorScale(selectedData[selectedData.length - 1].jamming_indicator)});


    function moveLine(elem, size,start){

      const t = d3.transition().duration(500).ease(d3.easeLinear);

      elem.attr('stroke', function(d){return colorScale(d.remaining)})
          .style('stroke-width', size * 5)
          .attr('d', function(d){return line([d.startlatLng,d.startlatLng])})
          .transition(t)
          .attr('d', function(d){return line([d.startlatLng,d.endlatLng])});
    }

    function moveCircle(elem, size, start){
      const t = d3.transition().duration(500).ease(d3.easeLinear);
      elem.attr("r", size * 5)
        .transition(t)
        .attr("cx", function(d){return proj.latLngToLayerPoint(start[start.length - 1].endlatLng).x;})
        .attr("cy", function(d){return proj.latLngToLayerPoint(start[start.length - 1].endlatLng).y;})

    }

      

      //


    /* d3.interval(function(){


  if (droneData.length !=0){
    start.push(droneData.shift());

    }
    size = 1 / proj.scale


    var path = sel.selectAll('path')
      .data(start)
      .enter().append('path')
    


    sel.selectAll('path').style('stroke-width', size * 5)

    moveLine(path, size, start);

    moveCircle(circle, size, start);  


    }, 500);
  */
        
  }, options = {zoomDraw:false});
      
  d3.csv("milestone3.csv",function(data){
      startlat = 323873506 / 10000000
      startlon = -1170765251 / 10000000
      droneData = data.map(function(d){
      endlat = d.lat/10000000  
      endlon =  d.lon/10000000 
      d.startlatLng = [+startlat,+startlon];    
      d.endlatLng = [+endlat,+endlon];
      // console.log("start",startlat,startlon)
      // console.log("end",endlat,endlon)
      startlat = endlat
      startlon = endlon
      return d;
    });
  pathOverlay.addTo(map);
  });
});

$(document).ready(function(){
    $('.tabs').tabs();
});

$(".tab").click(function() {
  id = this.id

  if (id == 'tab1') {
    console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab2') {
    console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab3') {
    console.log("Clicked", id);
    tab_clicked(id);
  }
  else if (id == 'tab4') {
    console.log("Clicked", id);
    tab_clicked(id);
  }
})


</script>
    
    
</body>
</html>